name: Process Issue Suggestion

on:
  issues:
    types: [opened, closed]
  pull_request:
    types: [closed]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  process-suggestion:
    if: github.event_name == 'issues' && github.event.action == 'opened'
    runs-on: ubuntu-latest
    concurrency:
      group: suggestion-process
      cancel-in-progress: false

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Process suggestion
        id: suggest
        run: python -m backend.suggest

      - name: Apply labels to issue
        if: steps.suggest.outputs.processed == 'true' && steps.suggest.outputs.label != ''
        uses: actions/github-script@v7
        with:
          script: |
            async function ensureLabel(labelName, color) {
              try {
                await github.rest.issues.getLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: labelName,
                });
              } catch (error) {
                if (error.status !== 404) {
                  throw error;
                }

                try {
                  await github.rest.issues.createLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    name: labelName,
                    color,
                  });
                } catch (createError) {
                  if (createError.status !== 422) {
                    throw createError;
                  }
                }
              }
            }

            const labels = ['suggestion', '${{ steps.suggest.outputs.label }}'];
            for (const labelName of labels) {
              await ensureLabel(
                labelName,
                labelName === 'suggestion' ? '0e8a16' : '5319e7'
              );
            }

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels,
            });

      - name: Push suggestion branch
        id: push_branch
        if: steps.suggest.outputs.processed == 'true' && steps.suggest.outputs.label != ''
        run: |
          BRANCH="suggestion/issue-${{ github.event.issue.number }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin main
          git checkout -B main origin/main
          git push origin --delete "$BRANCH" 2>/dev/null || true
          git checkout -b "$BRANCH"
          git add data/
          if git diff --cached --quiet; then
            echo "No data changes detected."
            echo "branch_pushed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          git commit -m "Add suggestion from issue #${{ github.event.issue.number }}"
          git fetch origin main
          git rebase origin/main
          git push -u origin "$BRANCH"
          echo "branch_pushed=true" >> "$GITHUB_OUTPUT"

      - name: Create GitHub PR
        if: steps.suggest.outputs.processed == 'true' && steps.suggest.outputs.label != '' && steps.push_branch.outputs.branch_pushed == 'true'
        id: github_pr
        uses: actions/github-script@v7
        with:
          script: |
            async function ensureLabel(labelName, color) {
              try {
                await github.rest.issues.getLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: labelName,
                });
              } catch (error) {
                if (error.status !== 404) {
                  throw error;
                }

                try {
                  await github.rest.issues.createLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    name: labelName,
                    color,
                  });
                } catch (createError) {
                  if (createError.status !== 422) {
                    throw createError;
                  }
                }
              }
            }

            await ensureLabel('suggestion-pr', '5319e7');

            const branch = `suggestion/issue-${context.payload.issue.number}`;
            const { data: existingPrs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${branch}`,
              state: 'open',
            });

            if (existingPrs.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingPrs[0].number,
                labels: ['suggestion-pr'],
              });
              core.setOutput('pr_url', existingPrs[0].html_url);
              return;
            }

            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Suggestion: ${context.payload.issue.title} (#${context.payload.issue.number})`,
              body: [
                `Closes #${context.payload.issue.number}`,
                ``,
                `**Label:** ${{ steps.suggest.outputs.label }}`,
                ``,
                `Merging this PR will update the site data, trigger a redeploy, and sync to DoltHub.`,
              ].join('\n'),
              head: branch,
              base: 'main',
            });

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: ['suggestion-pr'],
            });

            core.setOutput('pr_url', pr.html_url);

      - name: Comment on issue when no changes are detected
        if: success() && steps.suggest.outputs.processed == 'true' && steps.suggest.outputs.label != '' && steps.push_branch.outputs.branch_pushed != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: [
                `**Suggestion processed, but no data changes were needed.**`,
                ``,
                `The submitted data already matches the current dataset, so no pull request was created.`
              ].join('\n')
            });

      - name: Comment on issue with PR link
        if: success() && steps.suggest.outputs.processed == 'true' && steps.suggest.outputs.label != '' && steps.push_branch.outputs.branch_pushed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prUrl = '${{ steps.github_pr.outputs.pr_url }}';
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: [
                `**Your suggestion has been processed!**`,
                ``,
                `A pull request has been created for review: ${prUrl}`,
                ``,
                `A maintainer will review and merge if everything looks good.`
              ].join('\n')
            });

      - name: Comment on issue with error details
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: [
                `**Failed to process suggestion.**`,
                ``,
                `There was an error processing your suggestion. Please check the JSON format and try again.`,
                ``,
                `[View workflow run](${runUrl})`
              ].join('\n')
            });

      - name: Comment on issue for manual review
        if: success() && steps.suggest.outputs.manual_review == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            async function ensureLabel(labelName, color) {
              try {
                await github.rest.issues.getLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: labelName,
                });
              } catch (error) {
                if (error.status !== 404) {
                  throw error;
                }

                try {
                  await github.rest.issues.createLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    name: labelName,
                    color,
                  });
                } catch (createError) {
                  if (createError.status !== 422) {
                    throw createError;
                  }
                }
              }
            }

            await ensureLabel('manual-review', 'e4e669');

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['manual-review'],
            });
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: [
                `**Thanks for your suggestion!**`,
                ``,
                `This type of suggestion requires manual review by a maintainer. We'll take a look and add it if appropriate.`
              ].join('\n')
            });

  refresh-suggestion-prs:
    if: >-
      github.event_name == 'pull_request' && github.event.action == 'closed'
      && (
        startsWith(github.event.pull_request.head.ref, 'suggestion/')
        || (github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'main')
      )
    runs-on: ubuntu-latest
    concurrency:
      group: suggestion-refresh
      cancel-in-progress: false
    steps:
      - name: Refresh open suggestion PR branches
        uses: actions/github-script@v7
        with:
          script: |
            const closedPrNumber = context.payload.pull_request.number;
            const closedHeadRef = context.payload.pull_request.head.ref;

            const { data: openPrs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              base: 'main',
              per_page: 100,
            });

            for (const pr of openPrs) {
              if (!pr.head?.ref?.startsWith('suggestion/')) continue;
              if (pr.number === closedPrNumber) continue;
              if (pr.head.ref === closedHeadRef) continue;

              try {
                await github.rest.pulls.updateBranch({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: pr.number,
                  expected_head_sha: pr.head.sha,
                });
                console.log(`Queued branch update for PR #${pr.number}`);
              } catch (error) {
                const details = error?.response?.data?.message || error.message;
                console.log(`Could not update PR #${pr.number}: ${details}`);

                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  body: [
                    `Heads up: this suggestion branch could not be auto-updated after another PR was closed/merged.`,
                    ``,
                    `Please update this branch from main before merging to reduce conflicts.`,
                  ].join('\n'),
                });
              }
            }

  cleanup:
    if: >-
      (github.event_name == 'pull_request' && github.event.action == 'closed' && startsWith(github.event.pull_request.head.ref, 'suggestion/'))
      || (github.event_name == 'issues' && github.event.action == 'closed' && contains(github.event.issue.labels.*.name, 'suggestion'))
    runs-on: ubuntu-latest
    concurrency:
      group: suggestion-cleanup
      cancel-in-progress: false
    steps:
      - name: PR closed — reconcile issue and delete branch
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const branch = context.payload.pull_request.head.ref;
            const merged = Boolean(context.payload.pull_request.merged);
            // Extract issue number from branch name (suggestion/issue-N)
            const match = branch.match(/^suggestion\/issue-(\d+)$/);
            if (match) {
              const issueNumber = parseInt(match[1]);
              if (!merged) {
                console.log(`Closing issue #${issueNumber} as not planned`);
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  state: 'closed',
                  state_reason: 'not_planned',
                });
              }
            }
            try {
              console.log(`Deleting branch: ${branch}`);
              await github.rest.git.deleteRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `heads/${branch}`,
              });
            } catch (e) {
              console.log(`Branch ${branch} not found, skipping.`);
            }

      - name: Issue closed — close PR and delete branch
        if: github.event_name == 'issues' && github.event.action == 'closed'
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.payload.issue.number;
            const branch = `suggestion/issue-${issueNumber}`;
            // Find open PRs from this branch
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${branch}`,
              state: 'open',
            });
            for (const pr of prs) {
              console.log(`Closing PR #${pr.number}`);
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                state: 'closed',
              });
            }
            // Delete branch
            try {
              console.log(`Deleting branch: ${branch}`);
              await github.rest.git.deleteRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `heads/${branch}`,
              });
            } catch (e) {
              console.log(`Branch ${branch} not found, skipping.`);
            }
