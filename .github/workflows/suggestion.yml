name: Process Issue Suggestion

on:
  issues:
    types: [opened]
  pull_request:
    types: [closed]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  process-suggestion:
    if: github.event_name == 'issues'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Process suggestion
        id: suggest
        run: python -m backend.suggest

      - name: Apply label to issue
        if: steps.suggest.outputs.label != ''
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['${{ steps.suggest.outputs.label }}'],
            });

      - name: Push suggestion branch
        if: steps.suggest.outputs.label != ''
        run: |
          BRANCH="suggestion/issue-${{ github.event.issue.number }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git push origin --delete "$BRANCH" 2>/dev/null || true
          git checkout -b "$BRANCH"
          git add data/
          git commit -m "Add suggestion from issue #${{ github.event.issue.number }}"
          git push -u origin "$BRANCH"

      - name: Create GitHub PR
        if: steps.suggest.outputs.label != ''
        id: github_pr
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Suggestion: ${context.payload.issue.title} (#${context.payload.issue.number})`,
              body: [
                `Closes #${context.payload.issue.number}`,
                ``,
                `**Label:** ${{ steps.suggest.outputs.label }}`,
                ``,
                `Merging this PR will update the site data, trigger a redeploy, and sync to DoltHub.`,
              ].join('\n'),
              head: `suggestion/issue-${context.payload.issue.number}`,
              base: 'main',
            });
            core.setOutput('pr_url', pr.html_url);

      - name: Comment on issue with PR link
        if: success() && steps.suggest.outputs.label != ''
        uses: actions/github-script@v7
        with:
          script: |
            const prUrl = '${{ steps.github_pr.outputs.pr_url }}';
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: [
                `**Your suggestion has been processed!**`,
                ``,
                `A pull request has been created for review: ${prUrl}`,
                ``,
                `A maintainer will review and merge if everything looks good.`
              ].join('\n')
            });

      - name: Comment on issue with error details
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: [
                `**Failed to process suggestion.**`,
                ``,
                `There was an error processing your suggestion. Please check the JSON format and try again.`,
                ``,
                `[View workflow run](${runUrl})`
              ].join('\n')
            });

  cleanup-branch:
    if: >-
      github.event_name == 'pull_request'
      && !github.event.pull_request.merged
      && startsWith(github.event.pull_request.head.ref, 'suggestion/')
    runs-on: ubuntu-latest
    steps:
      - name: Delete suggestion branch
        uses: actions/github-script@v7
        with:
          script: |
            const branch = context.payload.pull_request.head.ref;
            console.log(`Deleting branch: ${branch}`);
            await github.rest.git.deleteRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `heads/${branch}`,
            });
