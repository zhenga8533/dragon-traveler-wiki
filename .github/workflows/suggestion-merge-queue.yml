name: Suggestion Merge Queue

on:
  pull_request_target:
    types:
      [
        opened,
        reopened,
        synchronize,
        labeled,
        unlabeled,
        ready_for_review,
        closed,
      ]
  pull_request_review:
    types: [submitted]
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: suggestion-merge-queue
  cancel-in-progress: false

jobs:
  update-queue-label-from-review:
    if: github.event_name == 'pull_request_review' && github.event.action == 'submitted'
    runs-on: ubuntu-latest
    steps:
      - name: Add/remove queue label based on review state
        uses: actions/github-script@v7
        with:
          script: |
            const reviewState = String(context.payload.review?.state || '').toLowerCase();
            const pr = context.payload.pull_request;

            if (!pr) {
              console.log('No pull request payload found.');
              return;
            }

            if (!pr.head?.ref?.startsWith('suggestion/')) {
              console.log(`PR #${pr.number} is not a suggestion PR.`);
              return;
            }

            if (pr.base?.ref !== 'main') {
              console.log(`PR #${pr.number} does not target main.`);
              return;
            }

            if (reviewState === 'approved') {
              try {
                await github.rest.issues.getLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: 'merge-queue',
                });
              } catch (error) {
                if (error.status !== 404) {
                  throw error;
                }

                try {
                  await github.rest.issues.createLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    name: 'merge-queue',
                    color: '1d76db',
                  });
                } catch (createError) {
                  if (createError.status !== 422) {
                    throw createError;
                  }
                }
              }

              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: ['merge-queue'],
              });
              console.log(`Added merge-queue label to PR #${pr.number}.`);
              return;
            }

            if (reviewState === 'changes_requested') {
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  name: 'merge-queue',
                });
                console.log(`Removed merge-queue label from PR #${pr.number}.`);
              } catch (error) {
                if (error.status !== 404) {
                  throw error;
                }
                console.log(`merge-queue label was not present on PR #${pr.number}.`);
              }
              return;
            }

            console.log(`Review state '${reviewState}' does not change queue status.`);

  merge-next:
    runs-on: ubuntu-latest
    steps:
      - name: Merge next queued suggestion PR
        uses: actions/github-script@v7
        with:
          script: |
            const sleep = (ms) => new Promise((resolve) => setTimeout(resolve, ms));
            const hasLabel = (pr, name) => (pr.labels || []).some((l) => l.name === name);

            const { data: openPrs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              base: 'main',
              sort: 'created',
              direction: 'asc',
              per_page: 100,
            });

            const queued = openPrs.filter((pr) => {
              return (
                pr.head?.ref?.startsWith('suggestion/') &&
                !pr.draft &&
                hasLabel(pr, 'merge-queue')
              );
            });

            if (queued.length === 0) {
              console.log('No queued suggestion PRs found.');
              return;
            }

            const next = queued[0];
            console.log(`Next queued PR: #${next.number} (${next.title})`);

            let prDetails = null;
            for (let i = 0; i < 6; i++) {
              const { data } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: next.number,
              });
              prDetails = data;
              if (prDetails.mergeable !== null) {
                break;
              }
              await sleep(3000);
            }

            if (!prDetails || prDetails.state !== 'open' || prDetails.draft) {
              console.log(`PR #${next.number} is no longer eligible.`);
              return;
            }

            if (prDetails.mergeable_state === 'behind') {
              try {
                await github.rest.pulls.updateBranch({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: next.number,
                  expected_head_sha: prDetails.head.sha,
                });
                console.log(`PR #${next.number} was behind; queued an update from main.`);
              } catch (error) {
                const details = error?.response?.data?.message || error.message;
                console.log(`Could not update PR #${next.number}: ${details}`);
              }
              return;
            }

            if (!prDetails.mergeable) {
              console.log(
                `PR #${next.number} is not mergeable yet (state=${prDetails.mergeable_state}).`
              );
              return;
            }

            if (!['clean', 'unstable', 'has_hooks'].includes(prDetails.mergeable_state)) {
              console.log(
                `PR #${next.number} is not ready for merge queue (state=${prDetails.mergeable_state}).`
              );
              return;
            }

            try {
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: next.number,
                merge_method: 'merge',
                commit_title: `Merge queued suggestion #${next.number}: ${next.title}`,
              });
              console.log(`Merged queued suggestion PR #${next.number}.`);
            } catch (error) {
              const details = error?.response?.data?.message || error.message;
              console.log(`Merge failed for PR #${next.number}: ${details}`);
            }
