name: Process Issue Suggestion

on:
  issues:
    types: [opened]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  process-suggestion:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Process suggestion
        id: suggest
        run: python -m backend.suggest

      - name: Apply label to issue
        if: steps.suggest.outputs.label != ''
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['${{ steps.suggest.outputs.label }}'],
            });

      - name: Create GitHub PR
        if: steps.suggest.outputs.label != ''
        id: github_pr
        run: |
          BRANCH="suggestion/issue-${{ github.event.issue.number }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git push origin --delete "$BRANCH" 2>/dev/null || true
          git checkout -b "$BRANCH"
          git add data/
          git commit -m "Add suggestion from issue #${{ github.event.issue.number }}"
          git push -u origin "$BRANCH"
          PR_URL=$(gh pr create \
            --title "Suggestion: ${{ github.event.issue.title }} (#${{ github.event.issue.number }})" \
            --body "Auto-generated from issue #${{ github.event.issue.number }}.

          **Label:** ${{ steps.suggest.outputs.label }}

          Merging this PR will update the site data, trigger a redeploy, and sync to DoltHub." \
            --base main)
          echo "pr_url=$PR_URL" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Comment on issue with PR link
        if: success() && steps.suggest.outputs.label != ''
        uses: actions/github-script@v7
        with:
          script: |
            const prUrl = '${{ steps.github_pr.outputs.pr_url }}';
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: [
                `**Your suggestion has been processed!**`,
                ``,
                `A pull request has been created for review: ${prUrl}`,
                ``,
                `A maintainer will review and merge if everything looks good.`
              ].join('\n')
            });

      - name: Comment on issue with error details
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: [
                `**Failed to process suggestion.**`,
                ``,
                `There was an error processing your suggestion. Please check the JSON format and try again.`,
                ``,
                `[View workflow run](${runUrl})`
              ].join('\n')
            });
