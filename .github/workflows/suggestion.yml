name: Process Issue Suggestion

on:
  issues:
    types: [opened]

permissions:
  contents: write
  issues: write

jobs:
  process-suggestion:
    runs-on: ubuntu-latest
    if: startsWith(github.event.issue.title, '[')
    concurrency:
      group: suggestion-process
      cancel-in-progress: false

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Process suggestion
        id: suggest
        run: python -m backend.suggest

      - name: Apply labels to issue
        if: steps.suggest.outputs.processed == 'true' && steps.suggest.outputs.label != ''
        uses: actions/github-script@v7
        with:
          script: |
            async function ensureLabel(labelName, color) {
              try {
                await github.rest.issues.getLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: labelName,
                });
              } catch (error) {
                if (error.status !== 404) {
                  throw error;
                }

                try {
                  await github.rest.issues.createLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    name: labelName,
                    color,
                  });
                } catch (createError) {
                  if (createError.status !== 422) {
                    throw createError;
                  }
                }
              }
            }

            const labels = ['suggestion', '${{ steps.suggest.outputs.label }}'];
            for (const labelName of labels) {
              await ensureLabel(
                labelName,
                labelName === 'suggestion' ? '0e8a16' : '5319e7'
              );
            }

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels,
            });

      - name: Comment on issue with labels
        if: success() && steps.suggest.outputs.processed == 'true' && steps.suggest.outputs.label != ''
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: [
                `**Thanks for your suggestion!**`,
                ``,
                `Your issue has been labeled and processed. A maintainer will review it soon.`
              ].join('\n')
            });

      - name: Comment on issue with error details
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: [
                `**Failed to process suggestion.**`,
                ``,
                `There was an error processing your suggestion. Please check the JSON format and try again.`,
                ``,
                `[View workflow run](${runUrl})`
              ].join('\n')
            });

      - name: Comment on issue for manual review
        if: success() && steps.suggest.outputs.manual_review == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            async function ensureLabel(labelName, color) {
              try {
                await github.rest.issues.getLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: labelName,
                });
              } catch (error) {
                if (error.status !== 404) {
                  throw error;
                }

                try {
                  await github.rest.issues.createLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    name: labelName,
                    color,
                  });
                } catch (createError) {
                  if (createError.status !== 422) {
                    throw createError;
                  }
                }
              }
            }

            await ensureLabel('manual-review', 'e4e669');

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['manual-review'],
            });
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: [
                `**Thanks for your suggestion!**`,
                ``,
                `This type of suggestion requires manual review by a maintainer. We'll take a look and add it if appropriate.`
              ].join('\n')
            });
